# Building Entity Lists on a Task's LUs

The task execution process executes the task's LUs from parent to child. 

Click for more information about the [execution order of hierarchical LUs](/articles/TDM/tdm_overview/03_business_entity_overview.md#task-execution-of-hierarchical-business-entities).

The task execution process builds an entity list for each LU, as described below. Root LUs and Children LUs require different steps:  

## Root LUs

The entity list of the root LUs is based on the task's selection method:

<table width="900pxl">
<tbody>
<tr>
<td width="300pxl">
<p><strong>Entity Selection Method</strong></p>
</td>
<td width="400pxl">
<p><strong>Where the Entities are Taken From</strong></p>
</td>
<td width="200pxl">
<p><strong>Task Types</strong></p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Entity list</p>
</td>
<td width="400pxl">
<p>Run the task on the list of entities that are set in the task itself or in the task overridden execution parameters</p>
</td>
<td width="200pxl">
<p>All task types</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Custom logic</p>
</td>
<td width="400pxl">
  <p>Run the selected <a href="/articles/TDM/tdm_implementation/11_tdm_implementation_using_generic_flows.md#step-7---optional---build-broadway-flows-for-the-custom-logic--selection-method">Broadway flow</a> to get the entity list</p>
</td>
<td width="200pxl">
<p>All task types</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Select a predefined entity list</p>
</td>
<td width="400pxl">
<p>Run the SQL query or the Broadway flow defined in the <a href="/articles/TDM/tdm_implementation/04_fabric_tdm_library.md#trnmigratelist">trnMigrateList</a> translation object for the LU.</p>
</td>
<td width="200pxl">
<p>Extract tasks</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Select all entities of the selected version</p>
</td>
<td width="400pxl">
<p>Select all entities that are successfully extracted by the selected data version. The entities are selected from TASK_EXECUTION_ENTITIES TDM DB table based on the task_execution_id of the selected data version.</p>
</td>
<td width="200pxl">
<p>Load data versioning tasks</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Parameters</p>
</td>
<td width="400pxl">
<p>Select the entities based on the task's parameters from a <a href="07_tdm_parameters_handling.md">DB view</a>, created in the TDM DB for each BE and source environment combination.</p>
</td>
<td width="200pxl">
<p>Regular load tasks (Data Versioning is cleared)</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Entity clone</p>
</td>
<td width="400pxl">
<p>Create duplications on the target environment of the Entity ID set in the task. Note that only one LUI is created on the entity ID.</p>
</td>
<td width="200pxl">
<p>Regular load tasks (Data Versioning is cleared)</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Random selection</p>
</td>
<td width="400pxl">
<p>Randomly select the entities from the <a href="/articles/TDM/tdm_implementation/07_tdm_implementation_parameters_handling.md#tdm-parameter-tables">&lt;LU Name&gt;_&lt;params&gt;</a> table.</p>
</td>
<td width="200pxl">
<p>Regular load tasks (Data Versioning is cleared)</p>
</td>
</tr>
<tr>
<td width="300pxl">
<p><h4>Generate Synthetic Entities</p>
</td>
<td width="400pxl">
    <p>Create a list of dummy entities for generating synthetic entities tasks.</p>
</td>
<td width="200pxl">
<p>Generate tasks (Generate task action is checked).</p>    
</td>    
</tr>    
</tbody>
</table>



### Running a Broadway Flow to Get the Task's Entity List

The task's entity list is generated by a Broadway flow in the following scenarios:

- when using the **Custom Logic** selection method.

- when using the **Select a predefined entity list** selection method on an extract task when the [trnMigrateList object is populated with a Broadway flow](/articles/TDM/tdm_implementation/11_tdm_implementation_using_generic_flows.md#step-6---optional---get-the-entity-list-for-an-extract-all-task-using-a-broadway-flow).

- when generating a list of **dummy entities** for a **synthetic data generation** task. The **Synthetic** is concatenated to each generated ID to create a dummy LUI, e.g., Synthetic_84.

  Click [here] for more information about synthetic data generation tasks.

The Broadway flow gets the entities for the task execution and inserts them into a dedicated Cassandra table in the **k2_tdm** keyspace. A separate Cassandra entity table is created on each LU and has the following naming convention: [LU_NAME]_entity_list. The task execution process uses this table to select the entity list for the task execution.

The task execution process (**tdmExecuteTask** job) runs the **createLuExternalEntityListTable** Broadway flow to create the entity list's Cassandra table if needed.
Then the task execution process runs a BATCH job to execute the Broadway flow that extracts the entity list and populates the Cassandra table. This Broadway flow always receives the following parameters:

- LU_NAME: populated with the task's root LU.
- EXTERNAL_TABLE_FLOW: populated with the name of the Broadway flow that gets the entity list.
- NUM_OF_ENTITIES: populated with the number of entities for the task execution.

The batch_id is written to the task_execution_list TDM table to enable stopping the task execution during the entity list's Broadway flow execution.

## Children LUs

The entity list of a child LU must include all IDs related to parent IDs that have been successfully processed by the task execution.

Click for an [execution of hierarchical BE](/articles/TDM/tdm_overview/03_business_entity_overview.md#task-execution-of-hierarchical-business-entities) example.

The generated entity list is based on a JOIN of the [task_execution_entities](02_tdm_database.md#task_execution_entities) and the [TDM relationship tables](/articles/TDM/tdm_implementation/06_tdm_implementation_support_hierarchy.md#tdm-relationship-tables):

<p>&nbsp;</p>
<table width="900pxl">
<tbody>
<tr>
<td width="300pxl">
<p><strong>Task Actions</strong></p>
</td>
<td width="600pxl"><strong>SQL Query</strong></td>
</tr>
<tr>
<td width="300pxl">
<ul>
<li style="text-align: left;">Extract</li>
<li style="text-align: left;">Extract + Load</li>
<li style="text-align: left;">Extract + Load + Reserve</li>
<li style="text-align: left;">Load</li>
<li style="text-align: left;">Load + Reserve</li>
<li style="text-align: left;">Generate</li>
<li style="text-align: left;">Generate + Load</li>
<li style="text-align: left;">Generate + Load + Reserve</li>
</ul>
</td>
<td width="600pxl">
<p>SELECT rel.lu_type2_eid as child_entity_id <br />FROM task_execution_entities t, tdm_lu_type_relation_eid rel <br />where t.task_execution_id= &lt;task execution id&gt;<br />and t.execution_status = 'completed' <br />and t.lu_name = &lt;parent lu name&gt; <br />and t.source_env = rel.source_env <br />and t.lu_name = rel.lu_type_1 <br />and t.iid = rel. lu_type1_eid <br />and rel.lu_type_2= &lt;child lu name&gt; <br />and rel.version_name = &lt;empty string on a regular task <br />and the selected version name on a Data Versioning task&gt;;</p>
</td>
</tr>
<tr>
<td width="300pxl">
<ul>
<li style="text-align: left;">Extract + Load + Delete</li>
<li style="text-align: left;">Extract + Load + Delete+ Reserve</li>
<li style="text-align: left;">Load + Delete</li>
<li style="text-align: left;">Load + Delete + Reserve</li>
</ul>
</td>
<td width="600pxl">
<p>SELECT rel.lu_type2_eid as child_entity_id<br />FROM task_execution_entities t, tdm_lu_type_relation_eid rel <br />where t.task_execution_id= &lt;task execution id&gt; <br />and t.execution_status = 'completed' <br />and t.lu_name = &lt;parent lu name&gt; <br />and t.source_env = rel.source_env <br />and t.lu_name = rel.lu_type_1 <br />and t.iid = rel. lu_type1_eid <br />and rel.lu_type_2= &lt;child lu name&gt; <br />and rel.version_name = &lt;empty string on a regular task <br />and the selected version name on a Data Versioning task&gt;<br />UNION<br />SELECT rel.lu_type2_eid as child_entity_id<br />FROM task_execution_entities t, tdm_lu_type_rel_tar_eid rel <br />where t.task_execution_id= &lt;task execution id&gt; <br />and t.execution_status = 'completed' <br />and t.lu_name = &lt;parent lu name&gt; <br />and rel.target_env = &lt;target environment name&gt; <br />and t.lu_name = rel.lu_type_1 <br />and t.iid = rel. lu_type1_eid <br />and rel.lu_type_2= &lt;child lu name&gt;;</p>
</td>
</tr>
<tr>
<td width="300pxl">
<ul>
<li style="text-align: left;">Delete only</li>
</ul>
</td>
<td width="600pxl">
<p>SELECT rel.lu_type2_eid as child_entity_id<br />FROM task_execution_entities t, tdm_lu_type_rel_tar_eid rel <br />where t.task_execution_id= &lt;task execution id&gt; <br />and t.execution_status = 'completed' <br />and t.lu_name = &lt;parent lu name&gt; <br />and rel.target_env = &lt;target environment name&gt; <br />and t.lu_name = rel.lu_type_1 <br />and t.iid = rel. lu_type1_eid <br />and rel.lu_type_2= &lt;child lu name&gt;;</p>
</td>
</tr>
</tbody>
</table>



[![Previous](/articles/images/Previous.png)](03_task_execution_processes.md)[<img align="right" width="60" height="54" src="/articles/images/Next.png">](04_task_execution_overridden_parameters.md)





